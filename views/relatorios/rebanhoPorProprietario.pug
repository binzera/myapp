extends ../layout

block content
  .container
    h1 Rebanho por Ano (todos os proprietários)

    form(method='get' action='/relatorios/rebanho-por-proprietario' class='row g-3 mb-4')
      .col-md-3
        label.form-label(for='ano') Ano
        select.form-select(name='ano' id='ano')
          option(value='') -- Todos --
          each a in anos
            option(value=a selected=(a==anoSelecionado))= a
      .col-md-2.align-self-end
        button.btn.btn-primary(type='submit') Filtrar

    if rows && rows.length
      - const sexoLabel = s => (s=='M' ? 'Macho' : (s=='F' ? 'Fêmea' : s));
      - // agrupar por proprietario
      - const grouped = {};
      - rows.forEach(function(r){
      -   const p = r.proprietarioNome || 'Sem proprietário';
      -   if (!grouped[p]) grouped[p] = { items: [], subtotal: 0 };
      -   grouped[p].items.push(r);
      -   grouped[p].subtotal += (parseFloat(r.quantidade) || 0);
      - });
      - const proprietarios = Object.keys(grouped).sort();
      table.table.table-striped.table-sm
        thead
          tr
            th Proprietário
            th Sexo
            th Idade
            th.text-end Quantidade
        tbody
          - let totalGeral = 0;
          each prop in proprietarios
            - const group = grouped[prop];
            - totalGeral += group.subtotal;
            // linha de cabeçalho do proprietário com subtotal
            tr.table-primary
              td(colspan='3')
                strong= prop
              td.text-end
                strong= group.subtotal
            // linhas detalhadas por sexo/idade
            each item in group.items
              tr
                td
                td= sexoLabel(item.sexo)
                td= item.idade
                td.text-end= item.quantidade
        tfoot
          tr
            td(colspan='3') Total Geral
            td.text-end= totalGeral
    else
      p.text-muted Nenhum dado encontrado para os filtros selecionados.