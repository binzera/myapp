extends ../layout

block content
  .container.mt-5
    h1.mb-3 Lista de Despesas
    form#filtrosForm(method="GET" action="/despesas" style="display: flex; gap: 10px; align-items: flex-end;")
      .form-group
        label(for="ano") Filtrar por Ano
        select#ano.form-select(name="ano")
          option(value="0") Todos os anos
          each ano in anos
            option(value=ano selected=(ano.toString() === anoSelecionado)) #{ano}
      .form-group(style="width: 30%")
        label(for="descricaoFiltro") Filtrar por Descrição
        input#descricaoFiltro.form-control(type="text" name="descricaoFiltro" value=descricaoFiltro placeholder="Digite parte da descrição...")
      button.btn.btn-primary(type="submit") Filtrar
    table.table.table-striped.table-hover
      thead
        tr
          th Data
          th Descrição
          th Categoria
          th.text-center Quantidade
          th.text-center Valor Unitário (R$)
          th.text-center Valor Total (R$)
          th.text-center Ações
      tbody
        each despesa in despesas
          tr
            
            td= despesa.get('dataFormatada')
            td= despesa.get('descricao')
            td= despesa.get('categoriaNome')
            td.text-center= despesa.get('quantidade') || 'N/A'
            td.text-center= despesa.get('vl_unitario') ? despesa.get('vl_unitario').toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'N/A'
            td.text-center= despesa.get('vl_total') ? despesa.get('vl_total').toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'N/A'              
            td.text-center
              a.btn.btn-outline-warning.btn-sm(href=`/despesas/${despesa.id}/edit`, style="border:none; cursor:pointer;")
                i.bi.bi-pencil(title="Editar Despesa")
              form(action=`/despesas/${despesa.id}/delete` method="POST" style="display:inline;")
                button.btn.btn-outline-danger.btn-sm(type="submit", style="border:none; cursor:pointer;")
                  i.bi.bi-trash(title="Excluir Despesa")
        tr
          td(colspan="5") Total de despesas na página
          td.text-center= vlTotalDespesas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
          td
    div
      if totalPages > 1
        nav(aria-label="Paginação de despesas" style="display: flex; justify-content: flex-end;")
          ul.pagination.mt-2
            // Botão Primeira página
            if page > 1
              li.page-item
                a.page-link(href=`/despesas?ano=${anoSelecionado ? anoSelecionado : '0'}&descricaoFiltro=${descricaoFiltro}&page=1`) Primeira
            else
              li.page-item.disabled
                span.page-link Primeira
            // Botão Anterior
            if page > 1
              li.page-item
                a.page-link(href=`/despesas?ano=${anoSelecionado ? anoSelecionado : '0'}&descricaoFiltro=${descricaoFiltro}&page=${page-1}`) «
            else
              li.page-item.disabled
                span.page-link «
            // Números de página (máximo 5 ao redor da atual)
            - const start = Math.max(1, page - 2)
            - const end = Math.min(totalPages, page + 2)
            if start > 1
              li.page-item.disabled
                span.page-link ...
            each p in Array(end - start + 1).fill().map((_, i) => start + i)
              if p === page
                li.page-item.active
                  span.page-link= p
              else
                li.page-item
                  a.page-link(href=`/despesas?ano=${anoSelecionado ? anoSelecionado : '0'}&descricaoFiltro=${descricaoFiltro}&page=${p}`)= p
            if end < totalPages
              li.page-item.disabled
                span.page-link ...
            // Botão Próxima
            if page < totalPages
              li.page-item
                a.page-link(href=`/despesas?ano=${anoSelecionado ? anoSelecionado : '0'}&descricaoFiltro=${descricaoFiltro}&page=${page+1}`) »
            else
              li.page-item.disabled
                span.page-link »
            // Botão Última página
            if page < totalPages
              li.page-item
                a.page-link(href=`/despesas?ano=${anoSelecionado ? anoSelecionado : '0'}&descricaoFiltro=${descricaoFiltro}&page=${totalPages}`) Última
            else
              li.page-item.disabled
                span.page-link Última
    div.mt-2
        a.btn.btn-secondary(href="/", style="margin-right: 5px;") Voltar
        a.btn.btn-primary(href="/despesas/add") Adicionar
    script.
      document.getElementById('descricaoFiltro').addEventListener('input', function() {
        var filtro = this.value.toLowerCase();
        var linhas = document.querySelectorAll('tbody tr');
        linhas.forEach(function(linha) {
          var descricao = linha.querySelector('td:nth-child(2)');
          if (descricao && descricao.textContent.toLowerCase().includes(filtro)) {
            linha.style.display = '';
          } else {
            linha.style.display = 'none';
          }
        });
      });
